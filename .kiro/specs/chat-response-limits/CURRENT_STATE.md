# Текущие лимиты ответов и контекста сессии

## Размеры ответов (в токенах)

### OpenAI Configuration (`src/lib/config/api.js`)

**Обычный ответ:**

- `MAX_TOKENS`: 500 токенов (по умолчанию)
- Переменная окружения: `VITE_OPENAI_MAX_TOKENS`
- **В символах**: ~375-400 слов или ~2000-2500 символов

**Детальный ответ:**

- `DETAILED_MAX_TOKENS`: 4000 токенов (по умолчанию)
- Переменная окружения: `VITE_OPENAI_DETAILED_MAX_TOKENS`
- **В символах**: ~3000-3200 слов или ~16000-20000 символов

### Ollama Configuration (`src/lib/config/llm.js`)

**Обычный ответ:**

- `MAX_TOKENS`: 512 токенов (по умолчанию)
- Переменная окружения: `VITE_OLLAMA_MAX_TOKENS`
- **В символах**: ~384-410 слов или ~2048-2560 символов

**Контекстное окно:**

- `NUM_CTX`: 2048 токенов (по умолчанию)
- Переменная окружения: `VITE_OLLAMA_NUM_CTX`
- Это размер всей истории разговора, которую модель может "помнить"

## Размер контекста сессии

### История сообщений

**Текущее состояние:**

- ❌ **НЕТ ЖЕСТКОГО ЛИМИТА** на количество сообщений в истории
- История хранится в `InMemorySessionManager` без ограничений
- Все сообщения из `sessionContext.history` передаются в API

**Код в `src/routes/api/chat/+server.js` (строки 641-646):**

```javascript
// Add conversation history as individual messages
if (sessionContext?.history && sessionContext.history.length > 0) {
  sessionContext.history.forEach((entry) => {
    messages.push({ role: entry.role, content: entry.content });
  });
}
```

### Формат сообщений для API

Каждое сообщение в истории включает:

```javascript
{
  role: 'user' | 'assistant' | 'system',
  content: string,
  timestamp: number
}
```

### Системные промпты

Помимо истории сообщений, в каждый запрос добавляются:

1. **Базовый системный промпт** (~2000-3000 символов)
   - Инструкции по языку
   - Правила обработки команд
   - Контекстные правила
2. **Настройки курса** (если есть examProfile)
   - Информация о курсе
   - Режим (exam/practice)
   - Навыки в фокусе
3. **Инструкции агента** (если есть)
   - Специфичные для курса инструкции
4. **Дополнительные системные сообщения**
   - Напоминания о языке (3-5 сообщений)
   - Инструкции для детального ответа

## Проблемы текущей конфигурации

### 1. Неограниченная история

**Проблема:**

- При длинной сессии (10+ вопросов) история может превысить контекстное окно модели
- Для GPT-4: контекстное окно 8192 токена
- Для Ollama (qwen2.5:1.5b): контекстное окно 2048 токенов

**Пример расчета для 10 вопросов:**

- Системные промпты: ~1500 токенов
- 10 вопросов студента (по 50 токенов): 500 токенов
- 10 ответов бота (по 400 токенов): 4000 токенов
- **ИТОГО: ~6000 токенов**

Для Ollama это уже превышает лимит в 2048 токенов!

### 2. Маленький размер ответа

**Проблема:**

- 500 токенов = ~375 слов = ~2000 символов
- Этого недостаточно для:
  - Подробного объяснения сложной темы
  - Решения задачи с пояснениями
  - Ответа на несколько вопросов одновременно

**Пример:**
Студент спрашивает: "Объясни квадратные уравнения и покажи 3 примера"

- Объяснение: ~200 слов
- 3 примера с решениями: ~300 слов
- **ИТОГО: ~500 слов = ~666 токенов**

Текущий лимит в 500 токенов не позволит дать полный ответ!

### 3. Контекстное окно Ollama

**Проблема:**

- NUM_CTX = 2048 токенов для всей истории
- После 3-4 вопросов контекст начинает обрезаться
- Модель "забывает" начало разговора

## Рекомендации по улучшению

### 1. Увеличить размер ответа

**Для OpenAI:**

```bash
VITE_OPENAI_MAX_TOKENS=1500  # вместо 500
VITE_OPENAI_DETAILED_MAX_TOKENS=6000  # вместо 4000
```

**Для Ollama:**

```bash
VITE_OLLAMA_MAX_TOKENS=1024  # вместо 512
```

**Результат:**

- Обычный ответ: ~1125 слов (~6000 символов)
- Детальный ответ: ~4500 слов (~24000 символов)

### 2. Ограничить историю сообщений

**Вариант A: Последние N сообщений**

```javascript
// Берем только последние 10 сообщений (5 пар вопрос-ответ)
const recentHistory = sessionContext.history.slice(-10);
```

**Вариант B: Скользящее окно по токенам**

```javascript
// Берем сообщения пока не превысим лимит токенов
const maxHistoryTokens = 3000;
let totalTokens = 0;
const limitedHistory = [];

for (let i = sessionContext.history.length - 1; i >= 0; i--) {
  const messageTokens = estimateTokens(sessionContext.history[i].content);
  if (totalTokens + messageTokens > maxHistoryTokens) break;
  limitedHistory.unshift(sessionContext.history[i]);
  totalTokens += messageTokens;
}
```

**Вариант C: Суммаризация старых сообщений**

```javascript
// Последние 5 сообщений полностью + краткое резюме старых
const recentMessages = sessionContext.history.slice(-5);
const oldMessages = sessionContext.history.slice(0, -5);
const summary = await summarizeHistory(oldMessages);
```

### 3. Увеличить контекстное окно Ollama

```bash
VITE_OLLAMA_NUM_CTX=4096  # вместо 2048
```

**Внимание:** Это увеличит использование RAM!

- 2048 токенов ≈ 1-2 GB RAM
- 4096 токенов ≈ 2-4 GB RAM

### 4. Оптимизировать системные промпты

**Текущие системные промпты очень длинные:**

- Базовый промпт: ~2000 символов
- Множество повторяющихся инструкций о языке

**Можно сократить до:**

- Базовый промпт: ~800 символов
- Одно напоминание о языке вместо 5

## Предлагаемая конфигурация

### Для продакшена (OpenAI)

```env
# Увеличенные лимиты ответов
VITE_OPENAI_MAX_TOKENS=1500
VITE_OPENAI_DETAILED_MAX_TOKENS=6000

# Ограничение истории (в коде)
MAX_HISTORY_MESSAGES=20  # 10 пар вопрос-ответ
```

### Для локальной разработки (Ollama)

```env
# Увеличенные лимиты
VITE_OLLAMA_MAX_TOKENS=1024
VITE_OLLAMA_NUM_CTX=4096

# Ограничение истории (в коде)
MAX_HISTORY_MESSAGES=10  # 5 пар вопрос-ответ
```

## Оценка размеров

### Токены → Слова → Символы

**Приблизительная конверсия:**

- 1 токен ≈ 0.75 слова (английский)
- 1 токен ≈ 0.6 слова (русский, больше символов)
- 1 слово ≈ 5-6 символов (с пробелами)

**Примеры:**

| Токены | Слова (EN) | Слова (RU) | Символы |
| ------ | ---------- | ---------- | ------- |
| 500    | 375        | 300        | 2000    |
| 1000   | 750        | 600        | 4000    |
| 1500   | 1125       | 900        | 6000    |
| 2000   | 1500       | 1200       | 8000    |
| 4000   | 3000       | 2400       | 16000   |
| 6000   | 4500       | 3600       | 24000   |

### Размер типичного ответа

**Короткий ответ (500 токенов):**

```
Квадратное уравнение — это уравнение вида ax² + bx + c = 0, где a ≠ 0.

Для решения используется формула:
x = (-b ± √(b² - 4ac)) / 2a

Пример: x² + 5x + 6 = 0
a = 1, b = 5, c = 6
D = 25 - 24 = 1
x₁ = (-5 + 1) / 2 = -2
x₂ = (-5 - 1) / 2 = -3

Ответ: x = -2 или x = -3
```

~300 слов, ~1800 символов

**Средний ответ (1500 токенов):**
Может включить:

- Подробное объяснение концепции
- 3-4 примера с решениями
- Пояснения к каждому шагу
- Советы и распространенные ошибки

**Длинный ответ (6000 токенов):**
Может включить:

- Полное эссе на тему
- Множество примеров
- Теоретическую базу
- Практические применения
- Упражнения для практики
