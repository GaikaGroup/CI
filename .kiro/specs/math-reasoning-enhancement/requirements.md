# Requirements Document

## Introduction

Эта функция улучшает математические возможности AI-тьютора путем интеграции более мощных моделей для решения математических задач.

**Текущие проблемы:**

1. В некоторых агентах используется GPT-3.5-turbo вместо GPT-4-turbo
2. Ограничение MAX_TOKENS = 500 слишком мало для детальных решений (≈375 слов)
3. Агенты используют maxTokens: 1000, что недостаточно для сложных задач
4. Нет автоматического определения математических запросов для увеличения лимита токенов

**Решение:**

- Использовать GPT-4-turbo/GPT-4o для математических задач (больше токенов, лучше рассуждения)
- Увеличить MAX_TOKENS для математических запросов до 2000-4000
- Добавить автоматическое определение типа задачи
- Опционально: поддержка специализированных локальных моделей (qwen2.5-math, deepseek-math)

## Requirements

### Requirement 1

**User Story:** Как пользователь, я хочу получать полные пошаговые решения математических задач, чтобы понимать процесс решения и учиться на примерах.

#### Acceptance Criteria

1. WHEN пользователь отправляет математическую задачу THEN система SHALL определить, что это математический запрос
2. WHEN обнаружена математическая задача THEN система SHALL использовать модель с улучшенными математическими способностями
3. WHEN генерируется решение THEN оно SHALL включать пошаговое объяснение
4. WHEN решение содержит формулы THEN они SHALL корректно отображаться с использованием MathRenderer
5. WHEN решение завершено THEN оно SHALL включать проверку ответа
6. WHEN задача сложная THEN система SHALL предоставить промежуточные шаги и объяснения

### Requirement 2

**User Story:** Как администратор системы, я хочу настроить, какие модели использовать для математических задач, чтобы оптимизировать баланс между качеством, скоростью и стоимостью.

#### Acceptance Criteria

1. WHEN настраивается система THEN администратор SHALL иметь возможность указать модель для математических задач
2. WHEN доступны локальные математические модели THEN система SHALL поддерживать их использование (например, Qwen2.5-Math, DeepSeek-Math)
3. WHEN используется OpenAI THEN администратор SHALL выбрать между GPT-3.5, GPT-4, GPT-4o
4. WHEN настроена специализированная модель THEN система SHALL использовать её только для математических запросов
5. WHEN модель недоступна THEN система SHALL использовать fallback с логированием
6. WHEN изменяется конфигурация THEN изменения SHALL применяться без перезапуска системы
7. WHEN агент создаётся по умолчанию THEN maxTokens SHALL быть установлен в 4000 для детальных ответов
8. WHEN используется математический режим THEN maxTokens SHALL автоматически увеличиваться до 4000 если установлено меньшее значение

### Requirement 3

**User Story:** Как разработчик, я хочу, чтобы система автоматически определяла математические запросы, чтобы пользователям не нужно было вручную переключать режимы.

#### Acceptance Criteria

1. WHEN пользователь отправляет сообщение THEN система SHALL анализировать его содержимое
2. WHEN сообщение содержит математические термины THEN оно SHALL классифицироваться как математическое
3. WHEN сообщение содержит формулы или уравнения THEN оно SHALL классифицироваться как математическое
4. WHEN сообщение содержит числовые задачи THEN оно SHALL классифицироваться как математическое
5. WHEN классификация неоднозначна THEN система SHALL использовать контекст предыдущих сообщений
6. WHEN определён тип запроса THEN система SHALL логировать решение для мониторинга точности

### Requirement 4

**User Story:** Как пользователь, я хочу, чтобы система поддерживала различные типы математических задач, чтобы получать помощь по всем темам моего курса.

#### Acceptance Criteria

1. WHEN задача по алгебре THEN система SHALL решать уравнения, неравенства, системы
2. WHEN задача по геометрии THEN система SHALL работать с фигурами, теоремами, доказательствами
3. WHEN задача по математическому анализу THEN система SHALL вычислять производные, интегралы, пределы
4. WHEN задача по теории вероятностей THEN система SHALL решать задачи на вероятность и статистику
5. WHEN задача по дискретной математике THEN система SHALL работать с комбинаторикой, графами, логикой
6. WHEN задача включает визуализацию THEN система SHALL предлагать графики или диаграммы (если применимо)

### Requirement 5

**User Story:** Как пользователь, я хочу видеть качество решения и источник ответа, чтобы понимать надёжность предоставленной информации.

#### Acceptance Criteria

1. WHEN генерируется решение THEN система SHALL указывать, какая модель использовалась
2. WHEN решение получено от специализированной модели THEN это SHALL быть отмечено в интерфейсе
3. WHEN решение включает несколько подходов THEN система SHALL показать альтернативные методы
4. WHEN пользователь запрашивает детали THEN система SHALL объяснить выбор метода решения
5. WHEN решение может быть проверено THEN система SHALL предложить способ верификации
6. WHEN в режиме разработки THEN SHALL отображаться метаданные о выборе модели

### Requirement 6

**User Story:** Как оператор системы, я хочу мониторить производительность математических решений, чтобы оптимизировать конфигурацию и выявлять проблемы.

#### Acceptance Criteria

1. WHEN обрабатывается математический запрос THEN система SHALL логировать время ответа
2. WHEN используется специализированная модель THEN SHALL записываться метрика успешности
3. WHEN происходит fallback THEN SHALL логироваться причина и альтернативная модель
4. WHEN собираются метрики THEN они SHALL включать тип задачи и использованную модель
5. WHEN анализируется производительность THEN SHALL быть доступна статистика по типам задач
6. WHEN обнаружены проблемы THEN система SHALL генерировать алерты для администратора

### Requirement 7

**User Story:** Как пользователь с ограниченными ресурсами, я хочу иметь возможность использовать локальные математические модели, чтобы не зависеть от облачных API и их стоимости.

#### Acceptance Criteria

1. WHEN доступна локальная математическая модель THEN система SHALL предпочитать её использование
2. WHEN локальная модель Ollama настроена THEN система SHALL поддерживать математические модели (qwen2.5-math, deepseek-math)
3. WHEN локальная модель недостаточно мощная THEN система SHALL использовать облачный fallback
4. WHEN используется локальная модель THEN время ответа SHALL быть приемлемым (< 30 секунд)
5. WHEN локальная модель даёт неполный ответ THEN система SHALL автоматически дополнить через облачную модель
6. WHEN система работает офлайн THEN математические возможности SHALL оставаться доступными через локальные модели
