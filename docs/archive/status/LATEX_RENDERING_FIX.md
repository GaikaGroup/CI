# LaTeX Rendering Fix

## Проблемы

### 1. Символ градуса не отображается правильно

**Проблема:** Вместо символа градуса отображается `^\circ` как текст.

**Пример:**

```
В прямоугольном треугольнике (треугольнике с углом 90^\circ) сумма квадратов...
```

**Ожидаемый результат:** 90° (отрендеренный символ градуса)

### 2. LaTeX не применяется в команде /explain

**Проблема:** При использовании команды `/explain` математические выражения не оборачиваются в LaTeX, в то время как `/practice` работает корректно.

## Решения

### 1. Исправление рендеринга символа градуса

**Файл:** `src/lib/components/MathRenderer.svelte`

**Изменения:**

```javascript
// Добавлена обработка символа градуса
// Fix degree symbol: wrap ^\circ in $ if not already wrapped
html = html.replace(/([^$])\^\\circ(?!\$)/g, (match, before) => {
  return before + '$^\\circ$';
});

// Fix common LaTeX errors: ^\circC -> ^\circ C
html = html.replace(/\^\\circC/g, '$^\\circ$ C');
html = html.replace(/\^\\circ([A-Z])/g, '$^\\circ$ $1');
```

**Как работает:**

1. Находит все вхождения `^\circ` которые не обернуты в `$`
2. Автоматически оборачивает их в `$^\\circ$`
3. Обрабатывает специальные случаи типа `^\circC` → `$^\\circ$ C`

### 2. Усиление инструкций по LaTeX в System Prompt

**Файл:** `src/routes/api/chat/+server.js`

**Старая версия:**

```
MATHEMATICAL NOTATION:
- ALWAYS use LaTeX for mathematical formulas and equations
- Use $...$ for inline math: $x^2 + y^2 = z^2$
- Examples: $\frac{1}{2}$, $\sqrt{x}$
```

**Новая версия:**

```
MATHEMATICAL NOTATION - CRITICAL RULES:
⚠️ ALWAYS wrap ALL mathematical expressions in LaTeX delimiters!

INLINE MATH (use $...$):
- Variables: $x$, $y$, $a$, $b$
- Simple expressions: $x^2 + y^2 = z^2$
- Fractions: $\frac{1}{2}$, $\frac{a}{b}$
- Roots: $\sqrt{x}$, $\sqrt[3]{8}$
- Angles: $90^\circ$, $180^\circ$ (ALWAYS use $^\circ$ for degrees!)
- Functions: $\sin(x)$, $\cos(x)$, $\log(x)$

DISPLAY MATH (use $$...$$ for centered equations):
$$
a^2 + b^2 = c^2
$$

CRITICAL: For /explain command, you MUST use LaTeX for ALL math!
Examples:
- RIGHT: "В прямоугольном треугольнике (треугольнике с углом $90^\circ$) сумма квадратов..."
- WRONG: "В прямоугольном треугольнике (треугольнике с углом 90^\circ) сумма квадратов..."

- RIGHT: "Формула: $a^2 + b^2 = c^2$"
- WRONG: "Формула: a^2 + b^2 = c^2"
```

**Ключевые улучшения:**

1. ⚠️ Добавлены предупреждающие символы для привлечения внимания LLM
2. Явно указано "ALWAYS wrap ALL mathematical expressions"
3. Добавлены конкретные примеры для символа градуса
4. Добавлена секция "CRITICAL" с примерами правильного и неправильного использования
5. Специально упомянута команда `/explain` как требующая LaTeX

## Почему /practice работал, а /explain нет?

### Анализ

**Команда /practice:**

- Генерирует задачи
- Задачи обычно содержат много математики
- LLM естественным образом использует LaTeX для задач

**Команда /explain:**

- Объясняет концепции
- Содержит больше текста, меньше формул
- LLM может "забыть" обернуть математику в LaTeX

### Решение

Усиленные инструкции теперь явно указывают:

```
CRITICAL: For /explain command, you MUST use LaTeX for ALL math!
```

Это заставляет LLM обращать особое внимание на использование LaTeX при объяснениях.

## Тестирование

### Тест 1: Символ градуса

**Входные данные:**

```
/explain теорема пифагора
```

**Ожидаемый ответ:**

```
В прямоугольном треугольнике (треугольнике с углом $90^\circ$) сумма квадратов длин двух катетов равна квадрату длины гипотенузы.
```

**Отображение:** 90° (правильно отрендеренный символ)

### Тест 2: Формулы в /explain

**Входные данные:**

```
/explain квадратное уравнение
```

**Ожидаемый ответ:**

```
Квадратное уравнение имеет вид $ax^2 + bx + c = 0$, где $a \neq 0$.

Решение находится по формуле:
$$
x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}
$$
```

**Отображение:** Все формулы правильно отрендерены с KaTeX

### Тест 3: Смешанный контент

**Входные данные:**

```
/explain тригонометрия
```

**Ожидаемый ответ:**

```
Основные тригонометрические функции:
- Синус: $\sin(\alpha)$
- Косинус: $\cos(\alpha)$
- Тангенс: $\tan(\alpha) = \frac{\sin(\alpha)}{\cos(\alpha)}$

Для угла $90^\circ$: $\sin(90^\circ) = 1$
```

## Технические детали

### Обработка в MathRenderer

1. **Preprocessing:** Символы преобразуются в LaTeX команды

   ```javascript
   '°': '^\\circ'
   ```

2. **Auto-wrapping:** Незавернутые LaTeX команды автоматически оборачиваются

   ```javascript
   '^\circ' → '$^\\circ$'
   ```

3. **KaTeX rendering:** Обернутые выражения рендерятся KaTeX
   ```javascript
   katex.renderToString('$^\\circ$', { displayMode: false });
   ```

### Порядок обработки

1. LLM генерирует ответ с LaTeX (благодаря улучшенному prompt)
2. MathRenderer получает контент
3. Preprocessing заменяет символы на LaTeX команды
4. Auto-wrapping оборачивает незавернутые команды
5. KaTeX рендерит все математические выражения
6. Результат отображается пользователю

## Преимущества

1. ✅ Символ градуса отображается правильно
2. ✅ LaTeX применяется во всех командах, включая /explain
3. ✅ Автоматическая обработка незавернутых LaTeX команд
4. ✅ Улучшенные инструкции для LLM
5. ✅ Консистентное отображение математики

## Связанные файлы

- `src/lib/components/MathRenderer.svelte` - рендеринг математики
- `src/routes/api/chat/+server.js` - system prompt с инструкциями
- `src/lib/modules/chat/components/MessageList.svelte` - отображение сообщений

## Дополнительные улучшения

### Возможные будущие улучшения:

1. **Автоматическое обнаружение математики:**
   - Использовать ML для определения математического контента
   - Автоматически оборачивать в LaTeX

2. **Валидация LaTeX:**
   - Проверять корректность LaTeX перед рендерингом
   - Предлагать исправления для некорректного LaTeX

3. **Кэширование рендеринга:**
   - Кэшировать отрендеренные математические выражения
   - Ускорить повторное отображение

4. **Расширенная поддержка символов:**
   - Добавить больше математических символов
   - Поддержка специальных нотаций (химия, физика)

## Заключение

Обе проблемы решены:

1. Символ градуса теперь отображается правильно благодаря auto-wrapping
2. LaTeX применяется во всех командах благодаря улучшенным инструкциям в system prompt

Изменения минимальны и не ломают существующий функционал.
