# System Prompt Improvements

## Обзор изменений

Улучшен system prompt для решения проблем с контекстной осведомленностью и командой `/test`.

## Проблемы, которые решаем

### 1. Потеря контекста

**Проблема:** Бот переключался на случайные темы (например, с теоремы Пифагора на квантовую механику).

**Пример:**

```
Пользователь: "придумай вопросы по теории" (в контексте теоремы Пифагора)
Бот: Начал говорить о квантовой механике ❌
```

### 2. Неправильная команда /test

**Проблема:** Команда `/test` давала решенные задачи вместо тестовых вопросов с вариантами ответов.

**Ожидалось:**

- 5 вопросов
- 4 варианта ответа (A, B, C, D)
- БЕЗ правильных ответов

## Реализованные улучшения

### 1. Усиленная контекстная осведомленность

**Добавлено в system prompt:**

```
CRITICAL COMMAND CONTEXT RULES:
⚠️ BEFORE ANSWERING ANY COMMAND, YOU MUST:
1. READ THE ENTIRE CONVERSATION HISTORY ABOVE
2. IDENTIFY THE LAST TOPIC OR QUESTION DISCUSSED
3. VERIFY: What was the CURRENT topic in the last 3 messages?
4. APPLY THE COMMAND TO THAT TOPIC - NOT to a random topic!

⚠️ CONTEXT VERIFICATION CHECKLIST:
- What topic was discussed in the PREVIOUS message?
- What topic was discussed in the message BEFORE that?
- Is there a clear CURRENT topic of conversation?
- Does my answer relate to THIS CURRENT topic?

⚠️ NEVER switch topics randomly! If discussing "теорема Пифагора",
   do NOT suddenly talk about "квантовая механика"!
```

**Как это работает:**

1. LLM должен проверить последние 3 сообщения
2. Определить текущую тему разговора
3. Убедиться что ответ относится к ЭТОЙ теме
4. Явное предупреждение о недопустимости случайной смены темы

### 2. Улучшенная команда /test

**Старая версия:**

```
- /test or /тест or /prueba: Generate practice questions on the current topic
```

**Новая версия:**

```
- /test or /тест or /prueba: Generate a multiple-choice test with 5 questions
  on the current topic. Each question must have 4 answer options (A, B, C, D).
  DO NOT provide correct answers - the student must solve the test independently.
  Format: Question 1, then options A-D, then Question 2, etc.
```

**Добавлен пример использования:**

```
Example 6 (TEST command):
- Student: "теорема пифагора"
- You: [explain Pythagorean theorem]
- Student: "/тест"
- You MUST: Create 5 multiple-choice questions about Pythagorean theorem WITHOUT answers
- CORRECT format:
  "Вопрос 1: В прямоугольном треугольнике катеты равны 3 см и 4 см.
   Чему равна гипотенуза?
  A) 5 см
  B) 7 см
  C) 6 см
  D) 8 см

  Вопрос 2: ..."
- WRONG: Providing answers or solutions after questions
```

### 3. Дополнительные предупреждения

Добавлено в конец секции с примерами:

```
⚠️ For /test or /тест: Give ONLY questions with 4 options, NO answers!
```

## Спецификация команды /test

### Формат теста:

```
Вопрос 1: [Текст вопроса]
A) [Вариант A]
B) [Вариант B]
C) [Вариант C]
D) [Вариант D]

Вопрос 2: [Текст вопроса]
A) [Вариант A]
B) [Вариант B]
C) [Вариант C]
D) [Вариант D]

... (всего 5 вопросов)
```

### Требования:

1. ✅ Ровно 5 вопросов
2. ✅ Каждый вопрос имеет 4 варианта ответа (A, B, C, D)
3. ✅ НЕТ правильных ответов в выводе
4. ✅ Вопросы относятся к текущей теме разговора
5. ✅ Вопросы разного уровня сложности
6. ✅ Математические выражения в LaTeX

### Примеры правильных тестов:

#### Пример 1: Теорема Пифагора

```
Вопрос 1: В прямоугольном треугольнике катеты равны $3$ см и $4$ см.
Чему равна гипотенуза?
A) $5$ см
B) $7$ см
C) $6$ см
D) $8$ см

Вопрос 2: Какая формула выражает теорему Пифагора?
A) $a^2 + b^2 = c^2$
B) $a + b = c$
C) $a^2 - b^2 = c^2$
D) $a \cdot b = c$

Вопрос 3: В прямоугольном треугольнике гипотенуза равна $10$ см,
один катет $6$ см. Чему равен другой катет?
A) $8$ см
B) $4$ см
C) $16$ см
D) $12$ см

Вопрос 4: Для каких треугольников справедлива теорема Пифагора?
A) Только для прямоугольных
B) Для всех треугольников
C) Только для равнобедренных
D) Только для равносторонних

Вопрос 5: Если катеты прямоугольного треугольника равны $5$ см и $12$ см,
чему равна гипотенуза?
A) $13$ см
B) $17$ см
C) $15$ см
D) $11$ см
```

#### Пример 2: Квадратные уравнения

```
Вопрос 1: Какое уравнение является квадратным?
A) $ax^2 + bx + c = 0$
B) $ax + b = 0$
C) $ax^3 + bx^2 + c = 0$
D) $a + b + c = 0$

Вопрос 2: Чему равен дискриминант квадратного уравнения $x^2 - 5x + 6 = 0$?
A) $1$
B) $-1$
C) $25$
D) $11$

... (еще 3 вопроса)
```

## Тестирование

### Тест 1: Контекстная осведомленность

**Сценарий:**

```
1. Пользователь: "/объяснить теорема пифагора"
2. Бот: [объясняет теорему Пифагора]
3. Пользователь: "придумай вопросы по теории"
```

**Ожидаемый результат:**

- ✅ Бот создает вопросы ПО ТЕОРЕМЕ ПИФАГОРА
- ❌ Бот НЕ переключается на другую тему

### Тест 2: Команда /test

**Сценарий:**

```
1. Пользователь: "/объяснить квадратные уравнения"
2. Бот: [объясняет квадратные уравнения]
3. Пользователь: "/тест"
```

**Ожидаемый результат:**

```
Вопрос 1: [вопрос о квадратных уравнениях]
A) [вариант]
B) [вариант]
C) [вариант]
D) [вариант]

Вопрос 2: ...
... (всего 5 вопросов)

БЕЗ правильных ответов!
```

### Тест 3: Множественные команды

**Сценарий:**

```
1. Пользователь: "/объяснить производные"
2. Бот: [объясняет производные]
3. Пользователь: "/практика 3 задачи"
4. Бот: [дает 3 задачи БЕЗ решений]
5. Пользователь: "/тест"
6. Бот: [дает тест с 5 вопросами о производных]
```

**Ожидаемый результат:**

- ✅ Все команды относятся к производным
- ✅ /практика дает задачи БЕЗ решений
- ✅ /тест дает вопросы с 4 вариантами БЕЗ ответов

## Преимущества

### 1. Улучшенная контекстная осведомленность

- ✅ Бот не теряет тему разговора
- ✅ Явная проверка контекста перед ответом
- ✅ Предупреждение о недопустимости случайной смены темы

### 2. Правильная команда /test

- ✅ Четкий формат: 5 вопросов, 4 варианта
- ✅ БЕЗ правильных ответов
- ✅ Подходит для самопроверки студентов

### 3. Лучшая педагогическая ценность

- ✅ Студенты могут проверить свои знания
- ✅ Разнообразие форматов: задачи, тесты, эссе
- ✅ Все команды работают в контексте текущей темы

## Связанные изменения

### Файлы:

- ✅ `src/routes/api/chat/+server.js` - обновлен system prompt

### Документация:

- ✅ `SYSTEM_PROMPT_IMPROVEMENTS.md` - этот документ

## Дополнительные рекомендации

### Для дальнейшего улучшения:

1. **Добавить команду /answers:**
   - Показать правильные ответы на последний тест
   - Только после того как студент попытался решить

2. **Улучшить валидацию контекста:**
   - Использовать embeddings для проверки релевантности темы
   - Автоматически предупреждать о смене темы

3. **Расширить команду /test:**
   - Опция указать количество вопросов: `/тест 10`
   - Опция указать сложность: `/тест сложный`

4. **Добавить статистику:**
   - Отслеживать какие команды используются чаще
   - Анализировать качество генерируемых тестов

## Заключение

Улучшения решают две критические проблемы:

1. ✅ Потеря контекста - теперь бот проверяет тему перед ответом
2. ✅ Неправильный формат /test - теперь четкая спецификация

Изменения минимальны (только system prompt) и не требуют изменений в коде.
