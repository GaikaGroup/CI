# Long Text TTS Fix - Обработка длинных текстов для озвучивания

## Проблема
При получении длинных ответов от AI (например, при анализе PDF документов) TTS API возвращал ошибку 500, так как OpenAI TTS имеет ограничение ~4096 символов на один запрос.

## Решение
Добавлена автоматическая разбивка длинных текстов на части (chunks) с последовательным озвучиванием каждой части.

## Реализация

### 1. Функция разбиения текста `splitTextForTTS()`

Умная разбивка текста с сохранением естественных границ:

```javascript
function splitTextForTTS(text, maxChunkLength = 4000) {
  // 1. Разбивает по параграфам (двойной перенос строки)
  // 2. Если параграф слишком длинный - разбивает по предложениям
  // 3. Сохраняет естественные паузы в речи
  // 4. Возвращает массив частей текста
}
```

**Преимущества:**
- ✅ Разбивает по смысловым границам (параграфы, предложения)
- ✅ Не обрывает текст посередине слова
- ✅ Сохраняет естественность речи
- ✅ Оптимизирует размер частей

### 2. Обновлённая функция `synthesizeResponseSpeech()`

Автоматически определяет длинные тексты и обрабатывает их:

```javascript
export async function synthesizeResponseSpeech(text) {
  const MAX_TTS_LENGTH = 4000; // OpenAI TTS limit
  
  if (text.length > MAX_TTS_LENGTH) {
    // Разбить на части
    const chunks = splitTextForTTS(text, MAX_TTS_LENGTH);
    
    // Озвучить каждую часть последовательно
    for (let i = 0; i < chunks.length; i++) {
      await synthesizeSpeech(chunks[i], { priority: 1 });
      
      // Небольшая пауза между частями
      if (i < chunks.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    }
  } else {
    // Короткий текст - озвучить как обычно
    await synthesizeSpeech(text, { priority: 1 });
  }
}
```

## Пример работы

### Входной текст (5000+ символов):
```
Вот краткий разбор вакансии инженера по речевому искусственному интеллекту.

Суть роли
- Нужен ведущий инженер...
[много текста]
...список вопросов для собеседования.
```

### Обработка:
```
1. Определяем: текст длинный (5000 chars)
2. Разбиваем на 2 части:
   - Часть 1: "Вот краткий разбор... [3800 chars]"
   - Часть 2: "...список вопросов... [1200 chars]"
3. Озвучиваем часть 1 → пауза 100ms → озвучиваем часть 2
4. Пользователь слышит непрерывную речь
```

## Логи

### До исправления:
```
Error synthesizing speech: Synthesis API error (500): {"error":"Failed to synthesize speech"}
```

### После исправления:
```
Text is long (5000 chars), splitting into chunks for TTS
Split text into 2 chunks
Synthesizing chunk 1/2 (3800 chars)
Synthesis completed successfully (size: 113KB)
Synthesizing chunk 2/2 (1200 chars)
Synthesis completed successfully (size: 45KB)
Completed synthesizing all chunks
```

## Преимущества решения

1. **Прозрачность** - пользователь не замечает разбиения, слышит непрерывную речь
2. **Надёжность** - если одна часть не озвучилась, остальные всё равно воспроизведутся
3. **Гибкость** - легко настроить размер частей и паузы между ними
4. **Масштабируемость** - работает с текстами любой длины

## Настройки

Можно изменить параметры в коде:

```javascript
const MAX_TTS_LENGTH = 4000;  // Максимальная длина одной части
const CHUNK_DELAY = 100;      // Пауза между частями (мс)
```

## Тестирование

1. Загрузите PDF с большим текстом
2. Задайте вопрос в voice mode
3. Получите длинный ответ (>4000 символов)
4. Проверьте, что весь текст озвучивается без ошибок

## Совместимость

- ✅ Text mode - не затронут
- ✅ Voice mode - работает с разбиением
- ✅ Короткие тексты - работают как раньше
- ✅ Длинные тексты - автоматически разбиваются
