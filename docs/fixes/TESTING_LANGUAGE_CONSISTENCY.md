# Тестирование Языковой Консистентности

## Цель

Убедиться что бот всегда отвечает на том же языке, на котором ведется сессия, и не переключается на другие языки без явного запроса пользователя.

## Предварительные Требования

1. Запустите сервер разработки:
   ```bash
   npm run dev
   ```

2. Откройте браузер на `http://localhost:5173`

## Тестовые Сценарии

### Сценарий 1: Испанский Язык (Базовый)

**Цель:** Проверить что бот отвечает на испанском на протяжении всей сессии

**Шаги:**
1. Начните новую сессию (Fun mode или любой курс)
2. Задайте вопрос на испанском:
   ```
   ¿Cuánto vale algunos coches en España? Son accesibles para gente or caros?
   ```
3. Проверьте что ответ **полностью на испанском**
4. Задайте следующий вопрос на испанском:
   ```
   ¿Y qué pasa con los coches usados?
   ```
5. Проверьте что ответ **снова на испанском**
6. Задайте вопрос с неоднозначным языком:
   ```
   Dame un receto de paella Valenciana
   ```
7. Проверьте что ответ **все еще на испанском**

**Ожидаемый Результат:**
- ✅ Все ответы на испанском языке
- ✅ Нет переключений на английский или другие языки
- ✅ Даже при неоднозначных вопросах бот продолжает на испанском

### Сценарий 2: Русский Язык (Базовый)

**Цель:** Проверить что бот отвечает на русском на протяжении всей сессии

**Шаги:**
1. Начните новую сессию
2. Задайте вопрос на русском:
   ```
   Сколько стоят автомобили в России?
   ```
3. Проверьте что ответ **полностью на русском**
4. Задайте следующий вопрос:
   ```
   А какие марки самые популярные?
   ```
5. Проверьте что ответ **снова на русском**
6. Задайте вопрос с техническими терминами:
   ```
   Расскажи про electric vehicles в России
   ```
7. Проверьте что ответ **все еще на русском** (даже если термин на английском)

**Ожидаемый Результат:**
- ✅ Все ответы на русском языке
- ✅ Технические термины объясняются на русском
- ✅ Нет переключений на английский

### Сценарий 3: Английский Язык (Базовый)

**Цель:** Проверить что бот отвечает на английском

**Шаги:**
1. Начните новую сессию
2. Задайте вопрос на английском:
   ```
   How much do cars cost in the USA?
   ```
3. Проверьте что ответ **полностью на английском**
4. Задайте следующий вопрос:
   ```
   What about used cars?
   ```
5. Проверьте что ответ **снова на английском**

**Ожидаемый Результат:**
- ✅ Все ответы на английском языке

### Сценарий 4: Переключение Языка (Продвинутый)

**Цель:** Проверить что бот может переключиться на другой язык по явному запросу

**Шаги:**
1. Начните сессию на испанском:
   ```
   ¿Cuánto vale algunos coches en España?
   ```
2. Проверьте что ответ на испанском
3. Явно попросите ответить на английском:
   ```
   Please answer in English: What are the most popular car brands in Spain?
   ```
4. Проверьте что ответ **на английском**
5. Продолжите на английском:
   ```
   And what about electric cars?
   ```
6. Проверьте что ответ **продолжает быть на английском**

**Ожидаемый Результат:**
- ✅ Бот переключается на английский по явному запросу
- ✅ Продолжает отвечать на английском после переключения
- ✅ Не переключается обратно без запроса

### Сценарий 5: Смешанный Язык (Граничный Случай)

**Цель:** Проверить поведение при смешанном языке в вопросе

**Шаги:**
1. Начните сессию на русском:
   ```
   Расскажи про машины в России
   ```
2. Проверьте что ответ на русском
3. Задайте вопрос со смешанным языком:
   ```
   А что насчет Tesla и других electric vehicles?
   ```
4. Проверьте что ответ **на русском** (язык сессии)

**Ожидаемый Результат:**
- ✅ Бот продолжает отвечать на языке сессии (русском)
- ✅ Английские термины объясняются на русском

### Сценарий 6: Длинная Сессия (Стресс-Тест)

**Цель:** Проверить что язык остается консистентным в длинной сессии

**Шаги:**
1. Начните сессию на испанском
2. Задайте 10+ вопросов подряд на испанском
3. Проверьте что **все ответы на испанском**
4. Задайте вопрос с неоднозначным языком
5. Проверьте что ответ **все еще на испанском**

**Ожидаемый Результат:**
- ✅ Все ответы на испанском на протяжении всей сессии
- ✅ Нет "усталости" системы и переключений

## Проверка Логов

Во время тестирования проверяйте логи в консоли браузера и терминале сервера:

### Ожидаемые Логи в Терминале:

```
Language detected: es (confidence: 0.85)
Session language from history: es (confidence: 0.95)
Enhanced prompt for es (confidence: 0.95, level: ultra_strong, mixing: false)
Language validation: PASS
```

### Признаки Проблемы:

```
Language validation: FAIL
High severity language inconsistency detected
```

## Что Делать Если Тест Не Прошел

### Если бот переключился на другой язык:

1. **Проверьте логи** - найдите где произошло переключение
2. **Проверьте confidence** - низкая уверенность может быть причиной
3. **Проверьте историю** - возможно в истории был ответ на другом языке
4. **Создайте issue** с:
   - Точным текстом вопроса
   - Ожидаемым языком
   - Полученным языком
   - Логами из консоли
   - Ссылкой на сессию

### Если бот не переключается по явному запросу:

1. **Проверьте формулировку** - запрос должен быть явным:
   - ✅ "Please answer in English"
   - ✅ "Responde en español"
   - ❌ "in English" (недостаточно явно)
2. **Проверьте что новый язык поддерживается**
3. **Создайте issue** если проблема сохраняется

## Автоматизированные Тесты

Запустите автоматизированные тесты:

```bash
# Unit тесты для PromptEnhancer
npm run test:run tests/unit/chat/promptEnhancer.test.js

# Unit тесты для LanguageDetector
npm run test:run tests/unit/chat/LanguageDetector.test.js

# Все тесты чата
npm run test:run tests/unit/chat/
```

## Метрики Успеха

- ✅ **100%** консистентность языка в базовых сценариях
- ✅ **95%+** консистентность в граничных случаях
- ✅ **100%** успешных переключений по явному запросу
- ✅ **0** ложных переключений в длинных сессиях

## Известные Ограничения

1. **Очень короткие сообщения** (1-2 слова) могут быть неоднозначными
2. **Технические термины** на английском могут снизить уверенность детекции
3. **Смешанный язык** в одном предложении может вызвать путаницу

## Обратная Связь

Если вы нашли проблему с языковой консистентностью:

1. Создайте issue в GitHub
2. Укажите:
   - Язык сессии
   - Текст вопроса
   - Ожидаемый язык ответа
   - Фактический язык ответа
   - Логи из консоли
   - Ссылку на сессию (если возможно)

## Дополнительные Ресурсы

- [Документация по языковой консистентности](./language-consistency-fix-summary.md)
- [Усиление v2](./language-consistency-enhancement-v2.md)
- [Архитектура проекта](../../.kiro/steering/project-architecture.md)
