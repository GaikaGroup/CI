# Превью изображений в чате

## Описание изменений

Добавлена функциональность отображения превью изображений в сообщениях чата.

## Что было сделано

### 1. Улучшено отображение изображений в MessageList.svelte

- Изображения теперь отображаются в полном размере (до 400px ширины и 300px высоты)
- Добавлена возможность открыть изображение в новой вкладке по клику
- Улучшены стили с тенями и эффектами при наведении
- Добавлена поддержка клавиатурной навигации (Enter для открытия)
- Изображения адаптивны и корректно отображаются на разных устройствах

### 2. Исправлено сохранение изображений в базу данных

- Blob URLs конвертируются в base64 перед добавлением в store
- Изображения сохраняются в поле `metadata.images` при создании сообщения
- При загрузке сессии изображения восстанавливаются из metadata
- Изображения корректно отображаются после перезагрузки страницы

### 3. Исправлена конвертация изображений

- Blob URLs (временные) конвертируются в base64 (постоянные) перед сохранением
- Это позволяет изображениям сохраняться в базе данных и отображаться после перезагрузки
- Конвертация происходит асинхронно, не блокируя UI

### 4. Улучшен UX

- Курсор меняется на pointer при наведении на изображение
- Добавлены плавные переходы при наведении
- Изображения имеют закругленные углы и рамку
- Поддержка темной темы

## Технические детали

### Структура данных

Изображения хранятся в следующем формате:

```javascript
{
  id: messageId,
  type: 'user',
  content: 'Текст сообщения',
  images: ['data:image/png;base64,...', 'data:image/jpeg;base64,...'],
  metadata: {
    images: ['data:image/png;base64,...', 'data:image/jpeg;base64,...']
  }
}
```

**Важно:** Изображения конвертируются из blob URLs в base64 перед сохранением, так как blob URLs являются временными и не могут быть сохранены в базе данных.

### Измененные файлы

1. `src/lib/modules/chat/components/MessageList.svelte`
   - Улучшено отображение изображений
   - Добавлены стили для превью
   - Добавлена интерактивность

2. `src/routes/sessions/[id]/+page.svelte`
   - Добавлена конвертация blob URLs в base64 перед добавлением в store
   - Исправлено сохранение изображений в metadata
   - Исправлено восстановление изображений при загрузке

## Использование

Пользователь может:
1. Загрузить изображение через кнопку камеры
2. Отправить сообщение с изображением
3. Увидеть превью изображения в чате
4. Кликнуть на изображение для открытия в полном размере в новой вкладке
5. После перезагрузки страницы изображения остаются видимыми

## Тестирование

Для проверки функциональности:
1. Откройте сессию чата
2. Загрузите изображение через кнопку камеры
3. Убедитесь, что превью изображения отображается в поле ввода
4. Отправьте сообщение
5. **Проверьте, что изображение отображается в чате как превью, а не как "Uploaded image 1"**
6. Кликните на изображение - оно должно открыться в новой вкладке в полном размере
7. Перезагрузите страницу (F5)
8. Убедитесь, что изображение все еще отображается в чате
9. Проверьте, что OCR текст отображается отдельно под изображением (если есть)

### Ожидаемый результат

- Изображение должно отображаться как превью (не как текст "Uploaded image 1")
- Изображение должно быть кликабельным
- После перезагрузки изображение должно остаться видимым
- OCR текст должен отображаться отдельно от изображения
