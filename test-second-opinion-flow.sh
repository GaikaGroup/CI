#!/bin/bash

# Test Second Opinion Flow
# –ò–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
# 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ (Ollama qwen2.5:1.5b)
# 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç second opinion (OpenAI)

set -e

API_URL="http://localhost:3002"
SESSION_ID="cmh8ze4jd0005dusaoi5rdbxj"
QUESTION="–¢–µ–æ—Ä–µ–º–∞ –ü–∏—Ñ–∞–≥–æ—Ä–∞"

echo "=========================================="
echo "Test: Second Opinion Flow"
echo "=========================================="
echo ""

# –ù—É–∂–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞
# –î–ª—è curl —Ç–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å session cookie

echo "‚ö†Ô∏è  –î–ª—è curl —Ç–µ—Å—Ç–∞ –Ω—É–∂–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"
echo ""
echo "–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –≤–æ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:"
echo ""

echo "1Ô∏è‚É£  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: '$QUESTION'"
echo "   ‚Üí –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: Ollama (qwen2.5:1.5b)"
echo "   ‚Üí –û—Ç–≤–µ—Ç: –±—ã—Å—Ç—Ä—ã–π (5-10 —Å–µ–∫)"
echo ""

echo "2Ô∏è‚É£  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç 'Second Opinion'"
echo "   ‚Üí –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: OpenAI (gpt-4o-mini)"
echo "   ‚Üí –û—Ç–≤–µ—Ç: –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π"
echo ""

echo "=========================================="
echo "–ü—Ä—è–º–æ–π —Ç–µ—Å—Ç –º–æ–¥–µ–ª–µ–π:"
echo "=========================================="
echo ""

echo "üìù –¢–µ—Å—Ç 1: Ollama qwen2.5:1.5b (–¥–µ—Ñ–æ–ª—Ç–Ω–∞—è)"
echo "---"
RESPONSE1=$(curl -s http://localhost:11434/api/chat -d "{
  \"model\": \"qwen2.5:1.5b\",
  \"messages\": [{\"role\": \"user\", \"content\": \"$QUESTION\"}],
  \"stream\": false
}" | jq -r '.message.content')

echo "$RESPONSE1" | head -10
echo "..."
echo ""

echo "üìù –¢–µ—Å—Ç 2: OpenAI —á–µ—Ä–µ–∑ API (second opinion)"
echo "---"
echo "‚ö†Ô∏è  –¢—Ä–µ–±—É–µ—Ç OPENAI_API_KEY –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é"
echo ""

echo "=========================================="
echo "–î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:"
echo "=========================================="
echo ""
echo "1. –û—Ç–∫—Ä–æ–π –±—Ä–∞—É–∑–µ—Ä: $API_URL/sessions/$SESSION_ID"
echo "2. –û—Ç–ø—Ä–∞–≤—å –≤–æ–ø—Ä–æ—Å: '$QUESTION'"
echo "3. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É 'Second Opinion'"
echo "4. –£–≤–∏–¥–∏—à—å –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞"
echo ""
echo "–õ–æ–≥–∏ –±—É–¥—É—Ç –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å–µ—Ä–≤–µ—Ä–∞."
