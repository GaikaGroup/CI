// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique @db.VarChar(255)
  firstName String   @map("first_name") @db.VarChar(100)
  lastName  String   @map("last_name") @db.VarChar(100)
  password  String   @db.VarChar(255) // Hashed password
  type      String   @default("regular") @db.VarChar(20) // 'admin', 'regular'
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  sessions        Session[]
  createdCourses  Course[] @relation("CourseCreator")
  enrollments     Enrollment[]
  preferences     UserPreference[]
  reportedCourses CourseReport[] @relation("CourseReporter")
  reviewedReports CourseReport[] @relation("CourseReviewer")
  systemLogs      SystemLog[]
  secondOpinions  SecondOpinion[]
  opinionFeedback OpinionFeedback[]
  
  // Indexes
  @@index([email], name: "idx_user_email")
  @@index([type], name: "idx_user_type")
  @@index([isActive, createdAt], name: "idx_user_stats") // For statistics queries
  @@map("users")
}

model Session {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  courseId     String?   @map("course_id") // Link to course in LEARN mode
  title        String    @db.VarChar(500)
  preview      String?   @db.Text
  language     String    @default("en") @db.VarChar(10)
  mode         String    @default("fun") @db.VarChar(20) // 'fun' or 'learn'
  isHidden     Boolean   @default(false) @map("is_hidden") // For soft delete functionality
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  messageCount Int       @default(0) @map("message_count")
  
  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull)
  messages       Message[]
  secondOpinions SecondOpinion[]
  
  // Indexes
  @@index([userId, updatedAt(sort: Desc)], name: "idx_user_sessions")
  @@index([courseId, updatedAt(sort: Desc)], name: "idx_course_sessions")
  @@index([title, preview], name: "idx_session_search")
  @@index([isHidden], name: "idx_session_visibility")
  @@index([userId, isHidden, updatedAt(sort: Desc)], name: "idx_user_sessions_visibility")
  @@index([userId, createdAt(sort: Desc), updatedAt(sort: Desc)], name: "idx_sessions_date_range")
  @@index([createdAt], name: "idx_session_stats") // For statistics queries
  @@map("sessions")
}

model Message {
  id        String   @id @default(cuid())
  sessionId String   @map("session_id")
  type      String   @db.VarChar(20) // 'user' or 'assistant'
  content   String   @db.Text
  metadata  Json?    // For storing audio, images, timestamps, second opinion info
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  session              Session         @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  primaryOpinions      SecondOpinion[] @relation("PrimaryMessage")
  secondOpinionMessage SecondOpinion?  @relation("OpinionMessage")
  
  // Indexes
  @@index([sessionId, createdAt], name: "idx_session_messages")
  @@index([sessionId, type], name: "idx_message_role")
  @@index([createdAt], name: "idx_message_stats") // For statistics queries
  @@map("messages")
}

model Course {
  id                 String   @id @default(cuid())
  name               String   @db.VarChar(255)
  slug               String   @unique @db.VarChar(100)
  description        String?  @db.Text
  language           String   @db.VarChar(10)
  level              String   @db.VarChar(50)
  skills             Json?    // Array of skills
  settings           Json?    // Course settings
  practice           Json?    // Practice mode settings
  exam               Json?    // Exam mode settings
  agents             Json?    // Course agents
  orchestrationAgent Json?    // Orchestration agent
  materials          Json?    // Course materials
  llmSettings        Json?    // LLM settings
  creatorId          String   @map("creator_id")
  creatorRole        String   @default("admin") @db.VarChar(20)
  status             String   @default("active") @db.VarChar(20)
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  
  // Relations
  creator            User                   @relation("CourseCreator", fields: [creatorId], references: [id])
  enrollments        Enrollment[]
  sessions           Session[]
  reports            CourseReport[]
  knowledgeGraphNodes KnowledgeGraphNode[]
  
  @@index([creatorId])
  @@index([status])
  @@index([language])
  @@index([name])
  @@index([slug])
  @@map("courses")
}

model Enrollment {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  courseId    String    @map("course_id")
  status      String    @default("active") @db.VarChar(20) // active, completed, dropped
  progress    Json?     // Progress tracking
  enrolledAt  DateTime  @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("enrollments")
}

model UserPreference {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  key       String   @db.VarChar(100)
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, key])
  @@index([userId])
  @@map("user_preferences")
}

model CourseReport {
  id          String    @id @default(cuid())
  courseId    String    @map("course_id")
  reporterId  String    @map("reporter_id")
  reason      String    @db.VarChar(255)
  description String?   @db.Text
  status      String    @default("pending") @db.VarChar(20) // pending, reviewed, resolved, dismissed
  priority    String    @default("medium") @db.VarChar(20) // low, medium, high, critical
  metadata    Json?     // Additional report data
  reviewedBy  String?   @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  reporter    User      @relation("CourseReporter", fields: [reporterId], references: [id])
  reviewer    User?     @relation("CourseReviewer", fields: [reviewedBy], references: [id])
  
  @@index([courseId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
  @@map("course_reports")
}

model SystemLog {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  level     String   @db.VarChar(20) // error, warn, info, debug
  category  String   @db.VarChar(50) // auth, course, enrollment, etc.
  message   String   @db.Text
  metadata  Json?    // Additional log data
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([level])
  @@index([category])
  @@index([createdAt])
  @@map("system_logs")
}

model SecondOpinion {
  id               String   @id @default(cuid())
  primaryMessageId String   @map("primary_message_id")
  opinionMessageId String   @unique @map("opinion_message_id")
  sessionId        String   @map("session_id")
  userId           String   @map("user_id")
  primaryProvider  String   @map("primary_provider") @db.VarChar(50)
  opinionProvider  String   @map("opinion_provider") @db.VarChar(50)
  primaryModel     String?  @map("primary_model") @db.VarChar(100)
  opinionModel     String?  @map("opinion_model") @db.VarChar(100)
  divergenceLevel  String?  @map("divergence_level") @db.VarChar(20) // 'low', 'medium', 'high'
  divergenceData   Json?    @map("divergence_data") // Detailed divergence analysis
  requestType      String   @default("automatic") @map("request_type") @db.VarChar(20) // 'automatic', 'manual'
  createdAt        DateTime @default(now()) @map("created_at")
  
  // Relations
  primaryMessage Message           @relation("PrimaryMessage", fields: [primaryMessageId], references: [id], onDelete: Cascade)
  opinionMessage Message           @relation("OpinionMessage", fields: [opinionMessageId], references: [id], onDelete: Cascade)
  session        Session           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedback       OpinionFeedback[]
  
  // Indexes
  @@index([primaryMessageId], name: "idx_second_opinion_primary")
  @@index([sessionId], name: "idx_second_opinion_session")
  @@index([userId], name: "idx_second_opinion_user")
  @@index([createdAt], name: "idx_second_opinion_created")
  @@index([opinionProvider], name: "idx_second_opinion_provider")
  @@map("second_opinions")
}

model OpinionFeedback {
  id        String        @id @default(cuid())
  opinionId String        @map("opinion_id")
  userId    String        @map("user_id")
  helpful   Boolean       // true = helpful, false = not helpful
  comment   String?       @db.Text
  createdAt DateTime      @default(now()) @map("created_at")
  
  // Relations
  opinion SecondOpinion @relation(fields: [opinionId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Constraints
  @@unique([opinionId, userId], name: "unique_opinion_user_feedback")
  
  // Indexes
  @@index([opinionId], name: "idx_feedback_opinion")
  @@index([userId], name: "idx_feedback_user")
  @@index([helpful], name: "idx_feedback_helpful")
  @@map("opinion_feedback")
}

model KnowledgeGraphNode {
  id         String   @id @default(cuid())
  materialId String   @map("material_id") @db.VarChar(255)
  courseId   String   @map("course_id")
  content    String   @db.Text
  chunkIndex Int      @map("chunk_index")
  metadata   Json?
  embedding  Unsupported("vector(384)")?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  
  // Relations
  course                Course                       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  sourceRelationships   KnowledgeGraphRelationship[] @relation("SourceNode")
  targetRelationships   KnowledgeGraphRelationship[] @relation("TargetNode")
  
  // Indexes
  @@index([materialId], name: "idx_kg_nodes_material")
  @@index([courseId], name: "idx_kg_nodes_course")
  @@index([createdAt], name: "idx_kg_nodes_created")
  @@map("knowledge_graph_nodes")
}

model KnowledgeGraphRelationship {
  id               String   @id @default(cuid())
  sourceNodeId     String   @map("source_node_id")
  targetNodeId     String   @map("target_node_id")
  relationshipType String   @map("relationship_type") @db.VarChar(100)
  weight           Float    @default(1.0)
  metadata         Json?
  createdAt        DateTime @default(now()) @map("created_at")
  
  // Relations
  sourceNode KnowledgeGraphNode @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode KnowledgeGraphNode @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([sourceNodeId], name: "idx_kg_rel_source")
  @@index([targetNodeId], name: "idx_kg_rel_target")
  @@index([relationshipType], name: "idx_kg_rel_type")
  @@unique([sourceNodeId, targetNodeId, relationshipType], name: "idx_kg_rel_unique")
  @@map("knowledge_graph_relationships")
}
